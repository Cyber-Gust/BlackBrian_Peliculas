<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Blog - Black Brian</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 400: "#6f9f6a", 500: "#4e7f49", 600: "#3d6538" },
                        dark: { 800: "#18181b", 900: "#09090b" }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f4f5; font-family: 'Inter', sans-serif; }
        .ql-container { height: 300px; background: white; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .ql-toolbar { background: white; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
    </style>
</head>
<body class="bg-zinc-100 pb-20">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="imgs/LOGO.png" class="h-10 bg-black p-1 rounded">
                <h1 class="font-bold text-zinc-700">Editor de Blog</h1>
            </div>
            <a href="/blog/index.html" target="_blank" class="text-sm text-brand-600 font-bold hover:underline">Ver Blog</a>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-6 mt-10">
        <form id="postForm" class="space-y-6">
            
            <div>
                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">T√≠tulo da Postagem</label>
                <input type="text" id="titulo" required onkeyup="gerarSlug()"
                    class="w-full bg-white border border-zinc-300 rounded-lg p-3 font-bold text-zinc-800 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>

            <div>
                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Slug (Link Amig√°vel)</label>
                <input type="text" id="slug" readonly
                    class="w-full bg-zinc-200 border border-zinc-300 rounded-lg p-2 text-sm text-zinc-600">
            </div>

            <div>
                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Imagem de Capa</label>
                <div class="flex items-center gap-4">
                    <label class="cursor-pointer w-full flex items-center justify-center border-2 border-dashed border-zinc-300 rounded-lg p-6 hover:border-brand-500 transition bg-white text-zinc-500 hover:text-brand-600">
                        <input type="file" id="imagem_upload" accept="image/*" class="hidden" required onchange="previewImagem(this)">
                        <div class="text-center" id="upload-label">
                            <span class="block text-2xl mb-1">üì∑</span>
                            <span class="text-sm font-bold">Clique para enviar imagem</span>
                        </div>
                        <img id="preview" class="hidden max-h-32 rounded object-cover" src="">
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Resumo (Para o Card)</label>
                <textarea id="resumo" rows="3"
                    class="w-full bg-white border border-zinc-300 rounded-lg p-3 text-zinc-800 focus:ring-2 focus:ring-brand-500 outline-none"></textarea>
            </div>

            <div>
                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Conte√∫do Completo</label>
                <div id="editor"></div>
            </div>

            <button type="submit" id="btnSalvar"
                class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                PUBLICAR POSTAGEM
            </button>

        </form>
    </main>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const SUPABASE_URL = 'https://vdxliqcozysjgomcfuhs.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkeGxpcWNvenlzamdvbWNmdWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDUwOTUsImV4cCI6MjA4MzEyMTA5NX0.-QUm03qwxrFJuCDQEv276PYLtOJEwEni478GrnMeEPI';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        var quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Escreva seu artigo incr√≠vel aqui...',
            modules: {
                toolbar: [
                    [{ 'header': [2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'clean']
                ]
            }
        });

        function gerarSlug() {
            const titulo = document.getElementById('titulo').value;
            const slug = titulo.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, "") 
                .replace(/[^\w\s-]/g, '') 
                .replace(/\s+/g, '-'); 
            document.getElementById('slug').value = slug;
        }

        // Fun√ß√£o visual para mostrar preview
        function previewImagem(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('preview').classList.remove('hidden');
                    document.getElementById('upload-label').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSalvar');
            const fileInput = document.getElementById('imagem_upload');
            
            btn.innerText = "ENVIANDO IMAGEM...";
            btn.disabled = true;

            // 1. Upload da Imagem
            let imagemUrlFinal = '';
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`; // Nome √∫nico usando timestamp
                const filePath = `capas/${fileName}`;

                const { data, error: uploadError } = await supabaseClient
                    .storage
                    .from('imgs_blog')
                    .upload(filePath, file);

                if (uploadError) {
                    alert('Erro no upload da imagem: ' + uploadError.message);
                    btn.disabled = false;
                    btn.innerText = "TENTAR NOVAMENTE";
                    return;
                }

                // Pega a URL p√∫blica
                const { data: publicUrlData } = supabaseClient
                    .storage
                    .from('imgs_blog')
                    .getPublicUrl(filePath);
                
                imagemUrlFinal = publicUrlData.publicUrl;
            } else {
                alert("Por favor, selecione uma imagem de capa.");
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
                return;
            }

            // 2. Salvar no Banco
            btn.innerText = "PUBLICANDO TEXTO...";

            const post = {
                titulo: document.getElementById('titulo').value,
                slug: document.getElementById('slug').value,
                imagem_capa: imagemUrlFinal, // URL gerada pelo bucket
                resumo: document.getElementById('resumo').value,
                conte√∫do: quill.root.innerHTML,
                publicado: true
            };

            const { error } = await supabaseClient.from('posts').insert([post]);

            if (error) {
                alert('Erro ao salvar post: ' + error.message);
                btn.innerText = "TENTAR NOVAMENTE";
            } else {
                alert('Sucesso! Artigo publicado.');
                window.location.reload();
            }
            btn.disabled = false;
        });
    </script>
</body>
</html>